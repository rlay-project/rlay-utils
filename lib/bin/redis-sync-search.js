#!/usr/bin/env node
"use strict";function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);e.length>r;r++)t[r]=e[r];return t}}var arrayWithoutHoles=_arrayWithoutHoles,arrayWithoutHoles$1=Object.freeze({default:arrayWithoutHoles,__moduleExports:arrayWithoutHoles});function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}var iterableToArray=_iterableToArray,iterableToArray$1=Object.freeze({default:iterableToArray,__moduleExports:iterableToArray});function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}var nonIterableSpread=_nonIterableSpread,nonIterableSpread$1=Object.freeze({default:nonIterableSpread,__moduleExports:nonIterableSpread}),arrayWithoutHoles$2=arrayWithoutHoles$1&&arrayWithoutHoles||arrayWithoutHoles$1,iterableToArray$2=iterableToArray$1&&iterableToArray||iterableToArray$1,nonIterableSpread$2=nonIterableSpread$1&&nonIterableSpread||nonIterableSpread$1;function _toConsumableArray(e){return arrayWithoutHoles$2(e)||iterableToArray$2(e)||nonIterableSpread$2()}var toConsumableArray=_toConsumableArray;function createCommonjsModule(e,r){return e(r={exports:{}},r.exports),r.exports}var runtime=createCommonjsModule(function(e){!function(r){var t,n=Object.prototype,o=n.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",u=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag",s=r.regeneratorRuntime;if(s)e.exports=s;else{(s=r.regeneratorRuntime=e.exports).wrap=b;var l="suspendedStart",f="suspendedYield",h="executing",p="completed",y={},d={};d[i]=function(){return this};var m=Object.getPrototypeOf,v=m&&m(m(O([])));v&&v!==n&&o.call(v,i)&&(d=v);var g=_.prototype=x.prototype=Object.create(d);E.prototype=g.constructor=_,_.constructor=E,_[c]=E.displayName="GeneratorFunction",s.isGeneratorFunction=function(e){var r="function"==typeof e&&e.constructor;return!!r&&(r===E||"GeneratorFunction"===(r.displayName||r.name))},s.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,c in e||(e[c]="GeneratorFunction")),e.prototype=Object.create(g),e},s.awrap=function(e){return{__await:e}},T(L.prototype),L.prototype[u]=function(){return this},s.AsyncIterator=L,s.async=function(e,r,t,n){var o=new L(b(e,r,t,n));return s.isGeneratorFunction(r)?o:o.next().then(function(e){return e.done?e.value:o.next()})},T(g),g[c]="Generator",g[i]=function(){return this},g.toString=function(){return"[object Generator]"},s.keys=function(e){var r=[];for(var t in e)r.push(t);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},s.values=O,A.prototype={constructor:A,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(R),!e)for(var r in this)"t"===r.charAt(0)&&o.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function n(n,o){return u.type="throw",u.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],u=i.completion;if("root"===i.tryLoc)return n("end");if(this.prev>=i.tryLoc){var c=o.call(i,"catchLoc"),s=o.call(i,"finallyLoc");if(c&&s){if(i.catchLoc>this.prev)return n(i.catchLoc,!0);if(i.finallyLoc>this.prev)return n(i.finallyLoc)}else if(c){if(i.catchLoc>this.prev)return n(i.catchLoc,!0)}else{if(!s)throw Error("try statement without catch or finally");if(i.finallyLoc>this.prev)return n(i.finallyLoc)}}}},abrupt:function(e,r){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(this.prev>=n.tryLoc&&o.call(n,"finallyLoc")&&n.finallyLoc>this.prev){var a=n;break}}!a||"break"!==e&&"continue"!==e||a.tryLoc>r||r>a.finallyLoc||(a=null);var i=a?a.completion:{};return i.type=e,i.arg=r,a?(this.method="next",this.next=a.finallyLoc,y):this.complete(i)},complete:function(e,r){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&r&&(this.next=r),y},finish:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var t=this.tryEntries[r];if(t.finallyLoc===e)return this.complete(t.completion,t.afterLoc),R(t),y}},catch:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var t=this.tryEntries[r];if(t.tryLoc===e){var n=t.completion;if("throw"===n.type){var o=n.arg;R(t)}return o}}throw Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:O(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),y}}}function b(e,r,t,n){var o=Object.create((r&&r.prototype instanceof x?r:x).prototype),a=new A(n||[]);return o._invoke=function(e,r,t){var n=l;return function(o,a){if(n===h)throw Error("Generator is already running");if(n===p){if("throw"===o)throw a;return j()}for(t.method=o,t.arg=a;;){var i=t.delegate;if(i){var u=$(i,t);if(u){if(u===y)continue;return u}}if("next"===t.method)t.sent=t._sent=t.arg;else if("throw"===t.method){if(n===l)throw n=p,t.arg;t.dispatchException(t.arg)}else"return"===t.method&&t.abrupt("return",t.arg);n=h;var c=w(e,r,t);if("normal"===c.type){if(n=t.done?p:f,c.arg===y)continue;return{value:c.arg,done:t.done}}"throw"===c.type&&(n=p,t.method="throw",t.arg=c.arg)}}}(e,t,a),o}function w(e,r,t){try{return{type:"normal",arg:e.call(r,t)}}catch(e){return{type:"throw",arg:e}}}function x(){}function E(){}function _(){}function T(e){["next","throw","return"].forEach(function(r){e[r]=function(e){return this._invoke(r,e)}})}function L(e){var r;this._invoke=function(t,n){function a(){return new Promise(function(r,a){!function r(t,n,a,i){var u=w(e[t],e,n);if("throw"!==u.type){var c=u.arg,s=c.value;return s&&"object"==typeof s&&o.call(s,"__await")?Promise.resolve(s.__await).then(function(e){r("next",e,a,i)},function(e){r("throw",e,a,i)}):Promise.resolve(s).then(function(e){c.value=e,a(c)},function(e){return r("throw",e,a,i)})}i(u.arg)}(t,n,r,a)})}return r=r?r.then(a,a):a()}}function $(e,r){var n=e.iterator[r.method];if(n===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,$(e,r),"throw"===r.method))return y;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return y}var o=w(n,e.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,y;var a=o.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,y):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function S(e){var r={tryLoc:e[0]};1 in e&&(r.catchLoc=e[1]),2 in e&&(r.finallyLoc=e[2],r.afterLoc=e[3]),this.tryEntries.push(r)}function R(e){var r=e.completion||{};r.type="normal",delete r.arg,e.completion=r}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function O(e){if(e){var r=e[i];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function r(){for(;++n<e.length;)if(o.call(e,n))return r.value=e[n],r.done=!1,r;return r.value=t,r.done=!0,r};return a.next=a}}return{next:j}}function j(){return{value:t,done:!0}}}(function(){return this||"object"==typeof self&&self}()||Function("return this")())}),runtime$1=Object.freeze({default:runtime,__moduleExports:runtime}),require$$0=runtime$1&&runtime||runtime$1,g=function(){return this||"object"==typeof self&&self}()||Function("return this")(),hadRuntime=g.regeneratorRuntime&&Object.getOwnPropertyNames(g).indexOf("regeneratorRuntime")>=0,oldRuntime=hadRuntime&&g.regeneratorRuntime;g.regeneratorRuntime=void 0;var runtimeModule=require$$0;if(hadRuntime)g.regeneratorRuntime=oldRuntime;else try{delete g.regeneratorRuntime}catch(e){g.regeneratorRuntime=void 0}var runtimeModule$1=Object.freeze({default:runtimeModule,__moduleExports:runtimeModule}),require$$0$1=runtimeModule$1&&runtimeModule||runtimeModule$1,regenerator=require$$0$1;function asyncGeneratorStep(e,r,t,n,o,a,i){try{var u=e[a](i),c=u.value}catch(e){return void t(e)}u.done?r(c):Promise.resolve(c).then(n,o)}function _asyncToGenerator(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){var a=e.apply(r,t);function i(e){asyncGeneratorStep(a,n,o,i,u,"next",e)}function u(e){asyncGeneratorStep(a,n,o,i,u,"throw",e)}i(void 0)})}}var asyncToGenerator=_asyncToGenerator,Web3=require("web3"),rlay=require("@rlay/web3-rlay"),redis=require("redis"),JsonRPC=require("simple-jsonrpc-js"),WebSocket=require("ws"),pLimit=require("p-limit"),mainWithConfig=function(){var e=asyncToGenerator(regenerator.mark(function e(){var r,t,n,o,a,i,u,c,s,l,f;return regenerator.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=require("yargs").env().option("index",{demandOption:!0,describe:"Name of the redisearch index"}).option("rpc-url",{describe:"URL of JSON-RPC endpoint"}).default("rpc-url","http://localhost:8546").option("ws-rpc-url",{describe:"URL of JSON-RPC Websocket endpoint"}).default("ws-rpc-url","ws://localhost:8547"),n=new Web3((t=r.argv).rpcUrl),rlay.extendWeb3WithRlay(n),o=redis.createClient(),a=pLimit(50),i=function(e){return a(function(){return rlay.retrieve(n,e)})},u=function(){var e=asyncToGenerator(regenerator.mark(function e(r){var t;return regenerator.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(r.annotations.map(i));case 2:if(t=e.sent.find(function(e){return e.property===rlay.builtins.labelAnnotationProperty})){e.next=6;break}return e.abrupt("return",null);case 6:return e.abrupt("return",rlay.decodeValue(t.value));case 7:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}(),c=function(){var e=asyncToGenerator(regenerator.mark(function e(r){var t;return regenerator.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=u(r).then(function(e){return r.label=e}),e.abrupt("return",Promise.all([t]).then(function(){return r}));case 2:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}(),s=function(e){c(e).then(function(e){o.send_command("FT.ADD",[t.index,e.cid,"1.0","REPLACE","FIELDS"].concat(toConsumableArray(e.label?["label",e.label]:[]),["cid",e.cid],["type",e.type]))})},l=function(){var e=new JsonRPC,r=new WebSocket(t.wsRpcUrl);e.on("rlay_subscribeEntities",["entity"],s),r.onmessage=function(r){e.messageHandler(r.data)},e.toStream=function(e){console.log("_msg",e),r.send(e)},r.onerror=function(e){console.error("Error: "+e.message)},r.onopen=function(){e.call("rlay_subscribeEntities",[{fromBlock:0}]).then(function(e){console.log("open",e)})}},f=function(){var e=asyncToGenerator(regenerator.mark(function e(){return regenerator.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise(function(e,r){o.send_command("FT.DROP",[t.index],function(t,n){return t?r(t):e(n)})}).catch(function(e){console.log("ERROR during index creation:",e)});case 2:return e.next=4,new Promise(function(e,r){o.send_command("FT.CREATE",[t.index,"SCHEMA"].concat(["label","TEXT","WEIGHT","3.0"],["cid","TEXT"],["type","TEXT","WEIGHT","1.0"]),function(t,n){return t?r(t):e(n)})});case 4:l();case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}(),e.next=14,f();case 14:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}();mainWithConfig();
